# Настройка LLM для Natural Language Understanding

Система теперь поддерживает два режима парсинга команд:

1. **LLM-режим (по умолчанию)**: Использует OpenAI API для понимания естественного языка
2. **Regex-режим (fallback)**: Использует регулярные выражения (старый способ)

## Преимущества LLM-режима

- ✅ Понимает **сотни вариантов** фраз без необходимости прописывать паттерны
- ✅ Понимает **синонимы** и **контекст** (например, "черкни", "мессага", "маякни" = отправить сообщение)
- ✅ Устойчив к **опечаткам** и **нестандартным формулировкам**
- ✅ Автоматически извлекает сущности (имена, текст сообщения)

## Быстрый старт

### 1. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 2. Настройка OpenAI API ключа

```bash
export OPENAI_API_KEY="sk-..."
```

Или добавьте в `~/.zshrc` / `~/.bashrc`:
```bash
export OPENAI_API_KEY="sk-ваш-ключ"
```

### 3. Запуск

Просто запустите агента как обычно - LLM будет использоваться автоматически:

```bash
python agent.py
# или
python agent.py "напиши Максиму Ершову: привет"
```

## Настройки

### Переменные окружения

- `OPENAI_API_KEY` (обязательно): Ваш API ключ OpenAI
- `OPENAI_MODEL` (опционально): Модель для использования (по умолчанию: `gpt-4o-mini`)
  - Рекомендуется: `gpt-4o-mini` (быстрая и дешёвая)
  - Альтернатива: `gpt-4o` (более точная, но дороже)
- `USE_LLM` (опционально): Включить/выключить LLM (по умолчанию: `1`)
  - `USE_LLM=0` - использовать только regex паттерны
  - `USE_LLM=1` - использовать LLM с fallback на regex

### Примеры настройки

```bash
# Использовать gpt-4o вместо gpt-4o-mini
export OPENAI_MODEL="gpt-4o"

# Отключить LLM и использовать только regex
export USE_LLM=0

# Полная настройка
export OPENAI_API_KEY="sk-..."
export OPENAI_MODEL="gpt-4o-mini"
export USE_LLM=1
```

## Как это работает

1. **Попытка LLM-парсинга**: Система отправляет команду в OpenAI API
2. **Извлечение структуры**: LLM возвращает JSON с `intent`, `target`, `message`
3. **Fallback на regex**: Если LLM не доступен или возвращает ошибку, используются regex паттерны
4. **Выполнение**: Извлечённая структура передаётся в `execute_command()`

## Примеры команд, которые теперь понимаются

Благодаря LLM система понимает множество вариантов:

### Отправка сообщений

- "Отправь Максиму Ершову сообщение Привет"
- "Напиши Петру что я задерживаюсь"
- "Черкни в Избранное: напомнить купить молоко"
- "Мессага Ивану: встреча в 15:00"
- "Маякни команде что проект готов"

### Открытие чата

- "Открой чат с Максимом Ершовым"
- "Открыть диалог с Петром"
- "Покажи чат Избранное"

### Вставка из буфера

- "Отправь из буфера в Избранное"
- "Вставь в чат с Максимом содержимое буфера"
- "Скопируй из буфера обмена в чат Петра"

## Стоимость

- **gpt-4o-mini**: ~$0.15 за 1M входных токенов, ~$0.60 за 1M выходных
- **Обычная команда**: ~50-100 токенов (~$0.00001-0.00002 за команду)
- **Очень дешёво** для персонального использования

## Troubleshooting

### Ошибка: "openai library is not installed"

Установите библиотеку:
```bash
pip install openai>=1.0.0
```

### Ошибка: "LLM parsing failed, falling back to regex patterns"

Проверьте:
1. Правильность `OPENAI_API_KEY`
2. Доступность интернета
3. Баланс на счёте OpenAI

Система автоматически использует regex паттерны в качестве fallback, поэтому продолжит работать.

### Хочу использовать только regex паттерны

```bash
export USE_LLM=0
```

## Дополнительные возможности

### Использование других моделей

Вы можете использовать любую модель OpenAI, которая поддерживает JSON mode:
- `gpt-4o-mini` (рекомендуется)
- `gpt-4o`
- `gpt-4-turbo`
- `gpt-3.5-turbo` (не рекомендуется, хуже понимает русский)

### Локальные модели (будущее)

Для использования локальных моделей (например, Ollama) можно модифицировать `parse_command_with_llm()` для работы с другими API.

